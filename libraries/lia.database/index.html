
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Official documentation for the Lilia Framework">
      
      
        <meta name="author" content="Lilia Framework Team">
      
      
        <link rel="canonical" href="https://liliaframework.github.io/libraries/lia.database/">
      
      
        <link rel="prev" href="../lia.data/">
      
      
        <link rel="next" href="../lia.derma/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Database Library - Lilia Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lavender">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-library" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Lilia Documentation" class="md-header__button md-logo" aria-label="Lilia Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lilia Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database Library
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lavender"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="lavender"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/LiliaFramework/Lilia" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../changelog/" class="md-tabs__link">
        
  
  
    
  
  Changelog

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../compatibility/" class="md-tabs__link">
        
  
  
    
  
  Addon Compatibility

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../gettingstarted/" class="md-tabs__link">
        
  
  
    
  
  Getting Started with Lilia

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation Guide

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../definitions/attributes/" class="md-tabs__link">
          
  
  
    
  
  Definitions

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../hooks/client/" class="md-tabs__link">
          
  
  
    
  
  Hooks

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lia.admin/" class="md-tabs__link">
          
  
  
    
  
  Libraries

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../meta/character/" class="md-tabs__link">
          
  
  
    
  
  Meta

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modules/" class="md-tabs__link">
          
  
  
    
  
  Modules

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Lilia Documentation" class="md-nav__button md-logo" aria-label="Lilia Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Lilia Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LiliaFramework/Lilia" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../compatibility/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Addon Compatibility
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started with Lilia
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../definitions/attributes/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../hooks/client/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Hooks
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Libraries
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Libraries
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.admin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Administrator Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.attributes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Attributes Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.bars/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bars Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.character/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Character Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.chatbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chatbox Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.classes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Classes Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.color/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Color Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.currency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Currency Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.darkrp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DarkRP Compatibility Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Database Library
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Database Library
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#connect" class="md-nav__link">
    <span class="md-ellipsis">
      connect
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wipetables" class="md-nav__link">
    <span class="md-ellipsis">
      wipeTables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loadtables" class="md-nav__link">
    <span class="md-ellipsis">
      loadTables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#waitfortablestoload" class="md-nav__link">
    <span class="md-ellipsis">
      waitForTablesToLoad
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#convertdatatype" class="md-nav__link">
    <span class="md-ellipsis">
      convertDataType
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inserttable" class="md-nav__link">
    <span class="md-ellipsis">
      insertTable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updatetable" class="md-nav__link">
    <span class="md-ellipsis">
      updateTable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#select" class="md-nav__link">
    <span class="md-ellipsis">
      select
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#selectwithcondition" class="md-nav__link">
    <span class="md-ellipsis">
      selectWithCondition
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#count" class="md-nav__link">
    <span class="md-ellipsis">
      count
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adddatabasefields" class="md-nav__link">
    <span class="md-ellipsis">
      addDatabaseFields
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exists" class="md-nav__link">
    <span class="md-ellipsis">
      exists
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#selectone" class="md-nav__link">
    <span class="md-ellipsis">
      selectOne
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bulkinsert" class="md-nav__link">
    <span class="md-ellipsis">
      bulkInsert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bulkupsert" class="md-nav__link">
    <span class="md-ellipsis">
      bulkUpsert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#insertorignore" class="md-nav__link">
    <span class="md-ellipsis">
      insertOrIgnore
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tableexists" class="md-nav__link">
    <span class="md-ellipsis">
      tableExists
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fieldexists" class="md-nav__link">
    <span class="md-ellipsis">
      fieldExists
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gettables" class="md-nav__link">
    <span class="md-ellipsis">
      getTables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transaction" class="md-nav__link">
    <span class="md-ellipsis">
      transaction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#escapeidentifier" class="md-nav__link">
    <span class="md-ellipsis">
      escapeIdentifier
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upsert" class="md-nav__link">
    <span class="md-ellipsis">
      upsert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete" class="md-nav__link">
    <span class="md-ellipsis">
      delete
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#createtable" class="md-nav__link">
    <span class="md-ellipsis">
      createTable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#createcolumn" class="md-nav__link">
    <span class="md-ellipsis">
      createColumn
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removetable" class="md-nav__link">
    <span class="md-ellipsis">
      removeTable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removecolumn" class="md-nav__link">
    <span class="md-ellipsis">
      removeColumn
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getcharactertable" class="md-nav__link">
    <span class="md-ellipsis">
      getCharacterTable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#createsnapshot" class="md-nav__link">
    <span class="md-ellipsis">
      createSnapshot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loadsnapshot" class="md-nav__link">
    <span class="md-ellipsis">
      loadSnapshot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#liagmregisterpreparedstatements" class="md-nav__link">
    <span class="md-ellipsis">
      lia.GM:RegisterPreparedStatements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#liagmsetupdatabase" class="md-nav__link">
    <span class="md-ellipsis">
      lia.GM:SetupDatabase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#liagmdatabaseconnected" class="md-nav__link">
    <span class="md-ellipsis">
      lia.GM:DatabaseConnected
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.derma/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Derma Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.doors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Doors Library Server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.factions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Faction Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.flags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flags Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.fonts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Font Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inventory Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.item/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.keybind/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Keybind Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.languages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Languages Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loader Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.logger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logger Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.menu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Menu Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.modularity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modularity Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.net/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Network Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.notice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Notice Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.option/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Option Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.playerinteract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Player Interaction Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.time/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Time Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.util/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utility Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.vendor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vendor Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.webimage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Image Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.websound/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebSound Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lia.workshop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workshop Library
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../meta/character/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Meta
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../modules/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="database-library">Database Library</h1>
<p>Comprehensive database management system with SQLite support for the Lilia framework.</p>
<hr />
<p>Overview</p>
<p>The database library provides comprehensive database management functionality for the Lilia framework. It handles all database operations including connection management, table creation and modification, data insertion, updates, queries, and schema management. The library supports SQLite as the primary database engine with extensible module support for other database systems. It includes advanced features such as prepared statements, transactions, bulk operations, data type conversion, and database snapshots for backup and restore operations. The library ensures data persistence across server restarts and provides robust error handling with deferred promise-based operations for asynchronous database queries. It manages core gamemode tables for players, characters, inventories, items, configuration, logs, and administrative data while supporting dynamic schema modifications.</p>
<hr />
<h3 id="connect">connect</h3>
<p><strong>Purpose</strong></p>
<p>Establishes a connection to the database using the configured database module</p>
<p><strong>When Called</strong></p>
<p>During server startup, module initialization, or when reconnecting to database</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>callback</code> (<em>function, optional</em>): Function to call after successful connection</li>
<li><code>reconnect</code> (<em>boolean, optional</em>): Force reconnection even if already connected</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>None</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">-- Simple: Connect to database with callback</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database connected successfully!&quot;</span><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">-- Medium: Connect with error handling and reconnection</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Database connection established&quot;</span><span class="p">)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">-- High: Connect with conditional logic and module validation</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kr">if</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">module</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">modules</span><span class="p">[</span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">module</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="s2">&quot;Database&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Connected to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">module</span><span class="p">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnDatabaseConnected&quot;</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">connected</span><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kr">else</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Invalid database module: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">module</span><span class="p">))</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="wipetables">wipeTables</h3>
<p><strong>Purpose</strong></p>
<p>Removes all Lilia database tables and their data from the database</p>
<p><strong>When Called</strong></p>
<p>During database reset operations, development testing, or administrative cleanup</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>callback</code> (<em>function, optional</em>): Function to call after all tables are wiped</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>None</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">-- Simple: Wipe all tables with confirmation</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">wipeTables</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All database tables have been wiped!&quot;</span><span class="p">)</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">-- Medium: Wipe tables with logging and backup</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Starting database wipe operation&quot;</span><span class="p">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">wipeTables</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Database wipe completed successfully&quot;</span><span class="p">)</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnDatabaseWiped&quot;</span><span class="p">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">-- High: Wipe tables with confirmation and error handling</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">confirmWipe</span><span class="p">()</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">wipeTables</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="s2">&quot;Database&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;All tables wiped successfully&quot;</span><span class="p">)</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span><span class="w"> </span><span class="c1">-- Reload empty tables</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnDatabaseReset&quot;</span><span class="p">)</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="kr">end</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="kr">if</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">config</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">&quot;allowDatabaseWipe&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="nf">confirmWipe</span><span class="p">()</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Database wipe not allowed by configuration&quot;</span><span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="loadtables">loadTables</h3>
<p><strong>Purpose</strong></p>
<p>Creates all core Lilia database tables if they don't exist and initializes the database schema</p>
<p><strong>When Called</strong></p>
<p>During server startup after database connection, or when initializing a new database</p>
<p><strong>Returns</strong></p>
<ul>
<li>None</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">-- Simple: Load tables after connection</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">-- Medium: Load tables with hook integration</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Database tables loaded successfully&quot;</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">-- High: Load tables with conditional logic and error handling</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">initializeDatabase</span><span class="p">()</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnDatabaseInitialized&quot;</span><span class="p">)</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="s2">&quot;Database&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Schema loaded and ready&quot;</span><span class="p">)</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kr">end</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="kr">if</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">module</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">modules</span><span class="p">[</span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="py">module</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="nf">initializeDatabase</span><span class="p">()</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Cannot initialize database: invalid module&quot;</span><span class="p">)</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="waitfortablestoload">waitForTablesToLoad</h3>
<p><strong>Purpose</strong></p>
<p>Returns a deferred promise that resolves when database tables have finished loading</p>
<p><strong>When Called</strong></p>
<p>Before performing database operations that require tables to be loaded</p>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">-- Simple: Wait for tables to load before proceeding</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">waitForTablesToLoad</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tables are ready!&quot;</span><span class="p">)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">-- Medium: Wait for tables with error handling</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">waitForTablesToLoad</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Database tables loaded, proceeding with initialization&quot;</span><span class="p">)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTablesReady&quot;</span><span class="p">)</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to load database tables: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">-- High: Wait for tables with timeout and fallback</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">initializeAfterTables</span><span class="p">()</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">waitForTablesToLoad</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="nf">loadCharacters</span><span class="p">()</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">inventory</span><span class="p">.</span><span class="nf">loadInventories</span><span class="p">()</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="s2">&quot;Database&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;All systems initialized&quot;</span><span class="p">)</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Critical database initialization failure: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="nf">initializeAfterTables</span><span class="p">()</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="kr">end</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="nf">initializeAfterTables</span><span class="p">()</span>
</span></code></pre></div></p>
<hr />
<h3 id="convertdatatype">convertDataType</h3>
<p><strong>Purpose</strong></p>
<p>Converts Lua values to SQL-compatible format with proper escaping and type handling</p>
<p><strong>When Called</strong></p>
<p>Internally by database functions when preparing data for SQL queries</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>value</code> (<em>any</em>): The value to convert to SQL format</li>
<li><code>noEscape</code> (<em>boolean, optional</em>): Skip escaping for raw SQL values</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>String representation of the value in SQL format</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">-- Simple: Convert basic data types</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">sqlString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">convertDataType</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kd">local</span><span class="w"> </span><span class="nv">sqlNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">convertDataType</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kd">local</span><span class="w"> </span><span class="nv">sqlBool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">convertDataType</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">-- Medium: Convert complex data with escaping</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">playerData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="nv">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="nv">isActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="nv">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">weapon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pistol&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ammo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">}</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">}</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="kd">local</span><span class="w"> </span><span class="nv">sqlData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kr">for</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">pairs</span><span class="p">(</span><span class="nv">playerData</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="nv">sqlData</span><span class="p">[</span><span class="nv">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">convertDataType</span><span class="p">(</span><span class="nv">value</span><span class="p">)</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">-- High: Convert with conditional logic and error handling</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">safeConvert</span><span class="p">(</span><span class="nv">value</span><span class="p">,</span><span class="w"> </span><span class="nv">fieldName</span><span class="p">)</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;NULL&quot;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">        </span><span class="kr">elseif</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="nv">value</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;table&quot;</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">success</span><span class="p">,</span><span class="w"> </span><span class="nv">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">pcall</span><span class="p">(</span><span class="nv">util</span><span class="p">.</span><span class="py">TableToJSON</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="p">)</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">                </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="nv">json</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">                </span><span class="kr">else</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">                    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Failed to convert table for field: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fieldName</span><span class="p">)</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">                    </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;NULL&quot;</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">                </span><span class="kr">end</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">                </span><span class="kr">else</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">                    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">convertDataType</span><span class="p">(</span><span class="nv">value</span><span class="p">)</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">                </span><span class="kr">end</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">            </span><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="inserttable">insertTable</h3>
<p><strong>Purpose</strong></p>
<p>Inserts a new record into a specified database table</p>
<p><strong>When Called</strong></p>
<p>When creating new database records for players, characters, items, etc.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>value</code> (<em>table</em>): Key-value pairs representing the data to insert</li>
<li><code>callback</code> (<em>function, optional</em>): Function to call after successful insertion</li>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'characters')</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results and lastID</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">-- Simple: Insert a new character</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertTable</span><span class="p">({</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;STEAM_0:1:12345678&quot;</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;models/player/kleiner.mdl&quot;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="p">},</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Character created with ID:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">-- Medium: Insert with error handling and validation</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">characterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">Name</span><span class="p">(),</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="nv">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">GetModel</span><span class="p">(),</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="nv">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;citizen&quot;</span><span class="p">,</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="nv">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="p">}</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertTable</span><span class="p">(</span><span class="nv">characterData</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="kr">if</span><span class="w"> </span><span class="nv">lastID</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character created for &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">Name</span><span class="p">())</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterCreated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">player</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="kr">end</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">-- High: Insert with validation, error handling, and rollback</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">createCharacterWithValidation</span><span class="p">(</span><span class="nv">playerData</span><span class="p">)</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="nf">validateData</span><span class="p">(</span><span class="nv">playerData</span><span class="p">)</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">validation</span><span class="p">.</span><span class="py">valid</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">reject</span><span class="p">(</span><span class="s2">&quot;Validation failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">validation</span><span class="p">.</span><span class="py">error</span><span class="p">)</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertTable</span><span class="p">(</span><span class="nv">playerData</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">lastID</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="p">[</span><span class="nv">lastID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">playerData</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterCreated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">,</span><span class="w"> </span><span class="nv">playerData</span><span class="p">)</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">)</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="updatetable">updateTable</h3>
<p><strong>Purpose</strong></p>
<p>Updates existing records in a specified database table based on conditions</p>
<p><strong>When Called</strong></p>
<p>When modifying existing database records for players, characters, items, etc.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>value</code> (<em>table</em>): Key-value pairs representing the data to update</li>
<li><code>callback</code> (<em>function, optional</em>): Function to call after successful update</li>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'characters')</li>
<li><code>condition</code> (<em>table/string, optional</em>): WHERE clause conditions for the update</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results and lastID</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">-- Simple: Update character money</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">updateTable</span><span class="p">({</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nv">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="p">},</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Character updated successfully!&quot;</span><span class="p">)</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">})</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">-- Medium: Update with complex conditions and logging</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">updateData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="nv">lastJoinTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="nv">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">character</span><span class="p">:</span><span class="nf">getMoney</span><span class="p">())</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">}</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">updateTable</span><span class="p">(</span><span class="nv">updateData</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="kr">if</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">character</span><span class="p">:</span><span class="nf">getName</span><span class="p">()</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; updated&quot;</span><span class="p">)</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterUpdated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">character</span><span class="p">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="kr">end</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">character</span><span class="p">:</span><span class="nf">getID</span><span class="p">()})</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">-- High: Update with validation, transaction, and rollback</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">updateCharacterWithValidation</span><span class="p">(</span><span class="nv">charID</span><span class="p">,</span><span class="w"> </span><span class="nv">updateData</span><span class="p">)</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">transaction</span><span class="p">({</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">,</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="s2">&quot;UPDATE lia_characters SET &quot;</span><span class="w"> </span><span class="o">..</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">lia</span><span class="p">.</span><span class="py">util</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nv">updateData</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">k</span><span class="p">,</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">convertDataType</span><span class="p">(</span><span class="nv">v</span><span class="p">)</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="kr">end</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">..</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="s2">&quot; WHERE id = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="p">,</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="s2">&quot;COMMIT&quot;</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="p">[</span><span class="nv">charID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">util</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="p">[</span><span class="nv">charID</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nv">updateData</span><span class="p">)</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterUpdated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">charID</span><span class="p">,</span><span class="w"> </span><span class="nv">updateData</span><span class="p">)</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to update character &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="select">select</h3>
<p><strong>Purpose</strong></p>
<p>Performs a SELECT query on a specified database table with optional conditions and limits</p>
<p><strong>When Called</strong></p>
<p>When retrieving data from database tables for players, characters, items, etc.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fields</code> (<em>string/table</em>): Field names to select (string or table of strings)</li>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'characters')</li>
<li><code>condition</code> (<em>table/string, optional</em>): WHERE clause conditions for the query</li>
<li><code>limit</code> (<em>number, optional</em>): Maximum number of records to return</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results array</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">-- Simple: Select all characters</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">results</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; characters&quot;</span><span class="p">)</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1">-- Medium: Select with conditions and specific fields</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">select</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;faction&quot;</span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;STEAM_0:1:12345678&quot;</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="p">},</span><span class="w"> </span><span class="mi">10</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="nv">char</span><span class="p">.</span><span class="py">name</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; has $&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">char</span><span class="p">.</span><span class="py">money</span><span class="p">)</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="kr">end</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">-- High: Select with complex conditions, pagination, and error handling</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getCharactersByFaction</span><span class="p">(</span><span class="nv">faction</span><span class="p">,</span><span class="w"> </span><span class="nv">page</span><span class="p">,</span><span class="w"> </span><span class="nv">pageSize</span><span class="p">)</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">pageSize</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="nv">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">faction</span><span class="p">,</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="nv">lastJoinTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">os.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">86400</span><span class="p">)}</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nv">pageSize</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">characters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">characters</span><span class="p">,</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nv">char</span><span class="p">))</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">characters</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to load characters: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="kr">return</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="selectwithcondition">selectWithCondition</h3>
<p><strong>Purpose</strong></p>
<p>Performs a SELECT query with advanced condition handling and optional ordering</p>
<p><strong>When Called</strong></p>
<p>When retrieving data with complex WHERE clauses and ORDER BY requirements</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fields</code> (<em>string/table</em>): Field names to select (string or table of strings)</li>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'characters')</li>
<li><code>conditions</code> (<em>table/string, optional</em>): WHERE clause conditions with operator support</li>
<li><code>limit</code> (<em>number, optional</em>): Maximum number of records to return</li>
<li><code>orderBy</code> (<em>string, optional</em>): ORDER BY clause for sorting results</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results array</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1">-- Simple: Select with basic condition</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">selectWithCondition</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nv">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;citizen&quot;</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">results</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; citizens&quot;</span><span class="p">)</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">-- Medium: Select with operators and ordering</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">selectWithCondition</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money&quot;</span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nv">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">},</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="nv">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;citizen&quot;</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="p">},</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money DESC&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="nv">char</span><span class="p">.</span><span class="py">name</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; has $&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">char</span><span class="p">.</span><span class="py">money</span><span class="p">)</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="kr">end</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1">-- High: Select with complex conditions, pagination, and error handling</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">searchCharacters</span><span class="p">(</span><span class="nv">searchTerm</span><span class="p">,</span><span class="w"> </span><span class="nv">faction</span><span class="p">,</span><span class="w"> </span><span class="nv">minMoney</span><span class="p">,</span><span class="w"> </span><span class="nv">maxResults</span><span class="p">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">conditions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">searchTerm</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">        </span><span class="nv">conditions</span><span class="p">.</span><span class="py">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LIKE&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;%&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">searchTerm</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;%&quot;</span><span class="p">}</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">faction</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">        </span><span class="nv">conditions</span><span class="p">.</span><span class="py">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">faction</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">minMoney</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">        </span><span class="nv">conditions</span><span class="p">.</span><span class="py">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">minMoney</span><span class="p">)}</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">selectWithCondition</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">conditions</span><span class="p">,</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="nv">maxResults</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lastJoinTime DESC&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">characters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">results</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">characters</span><span class="p">,</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nv">char</span><span class="p">))</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">characters</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Character search failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="kr">return</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="count">count</h3>
<p><strong>Purpose</strong></p>
<p>Counts the number of records in a database table matching specified conditions</p>
<p><strong>When Called</strong></p>
<p>When checking record counts for statistics, validation, or pagination</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>dbTable</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>condition</code> (<em>table/string, optional</em>): WHERE clause conditions for counting</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to the count number</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1">-- Simple: Count all characters</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total characters: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">-- Medium: Count with conditions</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nv">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;citizen&quot;</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="nv">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">}</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rich citizens: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">-- High: Count with validation and error handling</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getPlayerStats</span><span class="p">(</span><span class="nv">steamID</span><span class="p">)</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">steamID</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">charCount</span><span class="p">)</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">steamID</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">playerCount</span><span class="p">)</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="nv">characters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">charCount</span><span class="p">,</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="nv">playerRecords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">playerCount</span><span class="p">,</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">    </span><span class="nv">isNewPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">playerCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to get player stats: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">characters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">playerRecords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">isNewPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="adddatabasefields">addDatabaseFields</h3>
<p><strong>Purpose</strong></p>
<p>Dynamically adds new columns to the lia_characters table based on character variables</p>
<p><strong>When Called</strong></p>
<p>During database initialization to ensure character table has all required fields</p>
<p><strong>Returns</strong></p>
<ul>
<li>None</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">-- Simple: Add fields after table creation</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span><span class="w"> </span><span class="c1">-- This automatically calls addDatabaseFields()</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">-- Medium: Add fields with logging</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">addDatabaseFields</span><span class="p">()</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Database fields updated for character variables&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1">-- High: Add fields with validation and error handling</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">ensureCharacterFields</span><span class="p">()</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">istable</span><span class="p">(</span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">vars</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character variables not defined, skipping field addition&quot;</span><span class="p">)</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">        </span><span class="kr">return</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">addDatabaseFields</span><span class="p">()</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character database fields synchronized&quot;</span><span class="p">)</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterFieldsUpdated&quot;</span><span class="p">)</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="kr">end</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="nf">ensureCharacterFields</span><span class="p">()</span>
</span></code></pre></div></p>
<hr />
<h3 id="exists">exists</h3>
<p><strong>Purpose</strong></p>
<p>Checks if any records exist in a database table matching specified conditions</p>
<p><strong>When Called</strong></p>
<p>When validating data existence before operations or for conditional logic</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>dbTable</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>condition</code> (<em>table/string, optional</em>): WHERE clause conditions for checking existence</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to boolean (true if records exist)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1">-- Simple: Check if player exists</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;STEAM_0:1:12345678&quot;</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Player found in database&quot;</span><span class="p">)</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New player&quot;</span><span class="p">)</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1">-- Medium: Check with complex conditions</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="nv">faction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;citizen&quot;</span><span class="p">,</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="nv">money</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">operator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">}</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="kr">if</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Player has wealthy citizen character&quot;</span><span class="p">)</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="kr">end</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1">-- High: Check with validation and error handling</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">validatePlayerData</span><span class="p">(</span><span class="nv">steamID</span><span class="p">)</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">steamID</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">playerExists</span><span class="p">)</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">playerExists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertTable</span><span class="p">({</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">        </span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">steamID</span><span class="p">,</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">        </span><span class="nv">steamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">        </span><span class="nv">firstJoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">        </span><span class="nv">userGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;user&quot;</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;players&quot;</span><span class="p">)</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">playerExists</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to validate player data: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="selectone">selectOne</h3>
<p><strong>Purpose</strong></p>
<p>Retrieves a single record from a database table matching specified conditions</p>
<p><strong>When Called</strong></p>
<p>When fetching unique records like player data, character info, or single items</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fields</code> (<em>string/table</em>): Field names to select (string or table of strings)</li>
<li><code>dbTable</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>condition</code> (<em>table/string, optional</em>): WHERE clause conditions for the query</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to the first matching record or nil</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1">-- Simple: Get character by ID</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">selectOne</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">char</span><span class="p">)</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Character name: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">char</span><span class="p">.</span><span class="py">name</span><span class="p">)</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="kr">end</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1">-- Medium: Get player data with specific fields</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">selectOne</span><span class="p">({</span><span class="s2">&quot;steamName&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;userGroup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lastJoin&quot;</span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">()</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">playerData</span><span class="p">)</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="kr">if</span><span class="w"> </span><span class="nv">playerData</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">    </span><span class="nv">player</span><span class="p">:</span><span class="nf">SetUserGroup</span><span class="p">(</span><span class="nv">playerData</span><span class="p">.</span><span class="py">userGroup</span><span class="p">)</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Loaded player: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">playerData</span><span class="p">.</span><span class="py">steamName</span><span class="p">)</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="kr">end</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1">-- High: Get with validation and error handling</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">loadCharacter</span><span class="p">(</span><span class="nv">charID</span><span class="p">)</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">selectOne</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">charID</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">charData</span><span class="p">)</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">charData</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">reject</span><span class="p">(</span><span class="s2">&quot;Character not found&quot;</span><span class="p">)</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">character</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nv">charData</span><span class="p">)</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="p">[</span><span class="nv">charID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">character</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterLoaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">character</span><span class="p">)</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">character</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to load character &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="bulkinsert">bulkInsert</h3>
<p><strong>Purpose</strong></p>
<p>Inserts multiple records into a database table in a single operation for better performance</p>
<p><strong>When Called</strong></p>
<p>When inserting large amounts of data like inventory items, logs, or batch operations</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>dbTable</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>rows</code> (<em>table</em>): Array of tables containing the data to insert</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving when all records are inserted</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1">-- Simple: Insert multiple items</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="p">{</span><span class="nv">uniqueID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pistol&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="p">{</span><span class="nv">uniqueID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ammo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="p">}</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">bulkInsert</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Items inserted successfully&quot;</span><span class="p">)</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1">-- Medium: Insert with validation and error handling</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">insertInventoryItems</span><span class="p">(</span><span class="nv">invID</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="p">)</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">items</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rows</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">        </span><span class="nv">invID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">invID</span><span class="p">,</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">        </span><span class="nv">uniqueID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">uniqueID</span><span class="p">,</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">        </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">TableToJSON</span><span class="p">(</span><span class="nv">item</span><span class="p">.</span><span class="py">data</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}),</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">        </span><span class="nv">quantity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">quantity</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">        </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">        </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">bulkInsert</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">rows</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Inserted &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">rows</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; items into inventory &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">invID</span><span class="p">)</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to insert items: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1">-- High: Insert with batching, validation, and progress tracking</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">bulkInsertWithBatching</span><span class="p">(</span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">batchSize</span><span class="p">)</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="nv">batchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">batchSize</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">batchSize</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">batchSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="nv">data</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">batch</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="p">[</span><span class="nv">j</span><span class="p">])</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">batches</span><span class="p">,</span><span class="w"> </span><span class="nv">batch</span><span class="p">)</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentBatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">insertNextBatch</span><span class="p">()</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">currentBatch</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">#</span><span class="nv">batches</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">resolve</span><span class="p">()</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">bulkInsert</span><span class="p">(</span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">batches</span><span class="p">[</span><span class="nv">currentBatch</span><span class="p">]):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Batch &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">currentBatch</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">batches</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; completed&quot;</span><span class="p">)</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">        </span><span class="nv">currentBatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentBatch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nf">insertNextBatch</span><span class="p">()</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="w">    </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="kr">end</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="kr">return</span><span class="w"> </span><span class="nf">insertNextBatch</span><span class="p">()</span>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="bulkupsert">bulkUpsert</h3>
<p><strong>Purpose</strong></p>
<p>Performs bulk INSERT OR REPLACE operations for updating existing records or inserting new ones</p>
<p><strong>When Called</strong></p>
<p>When synchronizing data that may already exist, like configuration updates or data imports</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>dbTable</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>rows</code> (<em>table</em>): Array of tables containing the data to upsert</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving when all records are upserted</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1">-- Simple: Upsert configuration data</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="p">{</span><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;maxPlayers&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;32&quot;</span><span class="p">},</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="p">{</span><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;serverName&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;My Server&quot;</span><span class="p">}</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="p">}</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">bulkUpsert</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">configs</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuration updated&quot;</span><span class="p">)</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1">-- Medium: Upsert with validation and error handling</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">syncPlayerData</span><span class="p">(</span><span class="nv">players</span><span class="p">)</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">players</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rows</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">        </span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">        </span><span class="nv">steamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">Name</span><span class="p">(),</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">        </span><span class="nv">lastJoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">        </span><span class="nv">lastIP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">IPAddress</span><span class="p">(),</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">        </span><span class="nv">userGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">GetUserGroup</span><span class="p">()</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">bulkUpsert</span><span class="p">(</span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">rows</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Synchronized &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">rows</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; player records&quot;</span><span class="p">)</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to sync player data: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1">-- High: Upsert with conflict resolution and progress tracking</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">bulkSyncWithConflictResolution</span><span class="p">(</span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">conflictFields</span><span class="p">)</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">batchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">batchSize</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">batchSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="nv">data</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data</span><span class="p">[</span><span class="nv">j</span><span class="p">]</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">            </span><span class="c1">-- Add conflict resolution metadata</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">            </span><span class="nv">record</span><span class="p">.</span><span class="py">_syncTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">()</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">            </span><span class="nv">record</span><span class="p">.</span><span class="py">_conflictFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">conflictFields</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">batch</span><span class="p">,</span><span class="w"> </span><span class="nv">record</span><span class="p">)</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">batches</span><span class="p">,</span><span class="w"> </span><span class="nv">batch</span><span class="p">)</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">processNextBatch</span><span class="p">()</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">completed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">#</span><span class="nv">batches</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">resolve</span><span class="p">()</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">bulkUpsert</span><span class="p">(</span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">batches</span><span class="p">[</span><span class="nv">completed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">        </span><span class="nv">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">completed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Batch &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">completed</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">batches</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; synced&quot;</span><span class="p">)</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nf">processNextBatch</span><span class="p">()</span>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a><span class="w">    </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a><span class="kr">end</span>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a><span class="kr">return</span><span class="w"> </span><span class="nf">processNextBatch</span><span class="p">()</span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="insertorignore">insertOrIgnore</h3>
<p><strong>Purpose</strong></p>
<p>Inserts a record into a database table, ignoring the operation if it would cause a constraint violation</p>
<p><strong>When Called</strong></p>
<p>When inserting data that may already exist, like unique configurations or duplicate-safe operations</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>value</code> (<em>table</em>): Key-value pairs representing the data to insert</li>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'characters')</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results and lastID</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1">-- Simple: Insert configuration without duplicates</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertOrIgnore</span><span class="p">({</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;serverName&quot;</span><span class="p">,</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;My Server&quot;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="p">},</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuration inserted or ignored&quot;</span><span class="p">)</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1">-- Medium: Insert with validation and logging</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">ensureDefaultConfig</span><span class="p">(</span><span class="nv">configs</span><span class="p">)</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">configs</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertOrIgnore</span><span class="p">({</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">        </span><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">config</span><span class="p">.</span><span class="py">schema</span><span class="p">,</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">        </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">config</span><span class="p">.</span><span class="py">key</span><span class="p">,</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">        </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">config</span><span class="p">.</span><span class="py">value</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">lastID</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Added new config: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">config</span><span class="p">.</span><span class="py">key</span><span class="p">)</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">    </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="kr">end</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1">-- High: Insert with conflict detection and fallback</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">safeInsertWithFallback</span><span class="p">(</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">fallbackData</span><span class="p">)</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">insertOrIgnore</span><span class="p">(</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">lastID</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">        </span><span class="c1">-- Successfully inserted new record</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lastID</span><span class="p">,</span><span class="w"> </span><span class="nv">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;inserted&quot;</span><span class="p">}</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">        </span><span class="kr">else</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">            </span><span class="c1">-- Record already exists, try fallback operation</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">updateTable</span><span class="p">(</span><span class="nv">fallbackData</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">            </span><span class="p">[</span><span class="nv">data</span><span class="p">.</span><span class="py">primaryKey</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data</span><span class="p">.</span><span class="py">id</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">            </span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;updated&quot;</span><span class="p">}</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">        </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Insert or ignore failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">err</span><span class="p">}</span>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="tableexists">tableExists</h3>
<p><strong>Purpose</strong></p>
<p>Checks if a database table exists in the current database</p>
<p><strong>When Called</strong></p>
<p>When validating table existence before operations or during schema validation</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>tbl</code> (<em>string</em>): Table name to check for existence</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to boolean (true if table exists)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1">-- Simple: Check if table exists</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s2">&quot;lia_characters&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Characters table exists&quot;</span><span class="p">)</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Characters table missing&quot;</span><span class="p">)</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1">-- Medium: Check with conditional logic</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s2">&quot;lia_custom_table&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Custom table missing, creating...&quot;</span><span class="p">)</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createTable</span><span class="p">(</span><span class="s2">&quot;custom_table&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">not_null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;TEXT&quot;</span><span class="p">}</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="kr">end</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1">-- High: Check with validation and error handling</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">validateDatabaseSchema</span><span class="p">()</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">requiredTables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;inventories&quot;</span><span class="p">}</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">missingTables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">checkNextTable</span><span class="p">(</span><span class="nv">index</span><span class="p">)</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">#</span><span class="nv">requiredTables</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">missingTables</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">                </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Missing tables: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">missingTables</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">                </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadTables</span><span class="p">()</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">                </span><span class="kr">else</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">                    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;All required tables exist&quot;</span><span class="p">)</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">                    </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">resolve</span><span class="p">()</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">                </span><span class="kr">end</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lia_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">requiredTables</span><span class="p">[</span><span class="nv">index</span><span class="p">]</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">                </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">missingTables</span><span class="p">,</span><span class="w"> </span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nf">checkNextTable</span><span class="p">(</span><span class="nv">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="w">        </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-50-22"><a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-50-23"><a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nf">checkNextTable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-50-24"><a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="fieldexists">fieldExists</h3>
<p><strong>Purpose</strong></p>
<p>Checks if a specific field/column exists in a database table</p>
<p><strong>When Called</strong></p>
<p>When validating column existence before operations or during schema migrations</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>tbl</code> (<em>string</em>): Table name to check</li>
<li><code>field</code> (<em>string</em>): Field/column name to check for existence</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to boolean (true if field exists)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1">-- Simple: Check if field exists</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">fieldExists</span><span class="p">(</span><span class="s2">&quot;lia_characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Money field exists&quot;</span><span class="p">)</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Money field missing&quot;</span><span class="p">)</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1">-- Medium: Check with conditional field creation</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">fieldExists</span><span class="p">(</span><span class="s2">&quot;lia_characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;newField&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Adding new field to characters table&quot;</span><span class="p">)</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createColumn</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;newField&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;default_value&quot;</span><span class="p">)</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="kr">end</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1">-- High: Check with validation and error handling</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">validateCharacterFields</span><span class="p">()</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">requiredFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;steamID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;faction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;model&quot;</span><span class="p">}</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">missingFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">checkNextField</span><span class="p">(</span><span class="nv">index</span><span class="p">)</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">#</span><span class="nv">requiredFields</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">missingFields</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">                </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Missing character fields: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">missingFields</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">                </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">addDatabaseFields</span><span class="p">()</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">                </span><span class="kr">else</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="w">                    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;All required character fields exist&quot;</span><span class="p">)</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="w">                    </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">resolve</span><span class="p">()</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">                </span><span class="kr">end</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">fieldExists</span><span class="p">(</span><span class="s2">&quot;lia_characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">requiredFields</span><span class="p">[</span><span class="nv">index</span><span class="p">]):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">                </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">missingFields</span><span class="p">,</span><span class="w"> </span><span class="nv">requiredFields</span><span class="p">[</span><span class="nv">index</span><span class="p">])</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nf">checkNextField</span><span class="p">(</span><span class="nv">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">        </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nf">checkNextField</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="gettables">getTables</h3>
<p><strong>Purpose</strong></p>
<p>Retrieves a list of all Lilia database tables in the current database</p>
<p><strong>When Called</strong></p>
<p>When auditing database structure, generating reports, or managing tables</p>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to array of table names</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1">-- Simple: Get all Lilia tables</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">getTables</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">tables</span><span class="p">)</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">tables</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; Lilia tables&quot;</span><span class="p">)</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">tables</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="kr">end</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1">-- Medium: Get tables with analysis</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">getTables</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">tables</span><span class="p">)</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="kd">local</span><span class="w"> </span><span class="nv">coreTables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;lia_characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lia_players&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lia_items&quot;</span><span class="p">}</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="kd">local</span><span class="w"> </span><span class="nv">missingTables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">coreTable</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">coreTables</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">HasValue</span><span class="p">(</span><span class="nv">tables</span><span class="p">,</span><span class="w"> </span><span class="nv">coreTable</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">missingTables</span><span class="p">,</span><span class="w"> </span><span class="nv">coreTable</span><span class="p">)</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="kr">end</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">missingTables</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Missing core tables: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">missingTables</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;All core tables present&quot;</span><span class="p">)</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1">-- High: Get tables with validation and management</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">auditDatabaseStructure</span><span class="p">()</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">getTables</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">tables</span><span class="p">)</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tableStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">analyzeNextTable</span><span class="p">(</span><span class="nv">index</span><span class="p">)</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">#</span><span class="nv">tables</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Database audit complete:&quot;</span><span class="p">)</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">stats</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">pairs</span><span class="p">(</span><span class="nv">tableStats</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">                </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">stats</span><span class="p">.</span><span class="py">count</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records&quot;</span><span class="p">)</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">tableStats</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tables</span><span class="p">[</span><span class="nv">index</span><span class="p">]</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="nv">tableName</span><span class="p">:</span><span class="nf">sub</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="w">        </span><span class="nv">tableStats</span><span class="p">[</span><span class="nv">tableName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">count</span><span class="p">}</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nf">analyzeNextTable</span><span class="p">(</span><span class="nv">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="w">    </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="kr">end</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="kr">return</span><span class="w"> </span><span class="nf">analyzeNextTable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Database audit failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="kr">return</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="transaction">transaction</h3>
<p><strong>Purpose</strong></p>
<p>Executes multiple database queries as a single atomic transaction with rollback on failure</p>
<p><strong>When Called</strong></p>
<p>When performing complex operations that must succeed or fail together</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>queries</code> (<em>table</em>): Array of SQL query strings to execute in sequence</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving when all queries succeed or rejecting on failure</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1">-- Simple: Transfer money between characters</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">transaction</span><span class="p">({</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="s2">&quot;UPDATE lia_characters SET money = money - 100 WHERE id = 1&quot;</span><span class="p">,</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="s2">&quot;UPDATE lia_characters SET money = money + 100 WHERE id = 2&quot;</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Money transfer completed&quot;</span><span class="p">)</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transfer failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="c1">-- Medium: Create character with inventory</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">createCharacterWithInventory</span><span class="p">(</span><span class="nv">charData</span><span class="p">)</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">queries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">    </span><span class="s2">&quot;INSERT INTO lia_characters (steamID, name, faction) VALUES (&#39;&quot;</span><span class="w"> </span><span class="o">..</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">    </span><span class="nv">charData</span><span class="p">.</span><span class="py">steamID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;, &#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charData</span><span class="p">.</span><span class="py">name</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;, &#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charData</span><span class="p">.</span><span class="py">faction</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;)&quot;</span><span class="p">,</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">    </span><span class="s2">&quot;INSERT INTO lia_inventories (charID, invType) VALUES (last_insert_rowid(), &#39;pocket&#39;)&quot;</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">queries</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character and inventory created successfully&quot;</span><span class="p">)</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterCreated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">charData</span><span class="p">)</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to create character: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c1">-- High: Complex transaction with validation and rollback</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">transferItemsWithValidation</span><span class="p">(</span><span class="nv">fromChar</span><span class="p">,</span><span class="w"> </span><span class="nv">toChar</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="p">)</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">queries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">validationQueries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">    </span><span class="c1">-- Build validation queries</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">items</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">validationQueries</span><span class="p">,</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">        </span><span class="s2">&quot;SELECT COUNT(*) FROM lia_items WHERE invID = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fromChar</span><span class="p">.</span><span class="py">invID</span><span class="w"> </span><span class="o">..</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">        </span><span class="s2">&quot; AND uniqueID = &#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">uniqueID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39; AND quantity &gt;= &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">quantity</span><span class="p">)</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">    </span><span class="c1">-- Build transfer queries</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">items</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">queries</span><span class="p">,</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">        </span><span class="s2">&quot;UPDATE lia_items SET quantity = quantity - &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">quantity</span><span class="w"> </span><span class="o">..</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">        </span><span class="s2">&quot; WHERE invID = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fromChar</span><span class="p">.</span><span class="py">invID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; AND uniqueID = &#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">uniqueID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">queries</span><span class="p">,</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">        </span><span class="s2">&quot;INSERT OR REPLACE INTO lia_items (invID, uniqueID, quantity) VALUES (&quot;</span><span class="w"> </span><span class="o">..</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="w">        </span><span class="nv">toChar</span><span class="p">.</span><span class="py">invID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;, &#39;&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">uniqueID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;&#39;, &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">item</span><span class="p">.</span><span class="py">quantity</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">queries</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Items transferred successfully&quot;</span><span class="p">)</span>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnItemsTransferred&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">fromChar</span><span class="p">,</span><span class="w"> </span><span class="nv">toChar</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="p">)</span>
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Item transfer failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-59-25"><a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTransferFailed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">fromChar</span><span class="p">,</span><span class="w"> </span><span class="nv">toChar</span><span class="p">,</span><span class="w"> </span><span class="nv">items</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-59-26"><a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-59-27"><a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="escapeidentifier">escapeIdentifier</h3>
<p><strong>Purpose</strong></p>
<p>Escapes database identifiers (table names, column names) to prevent SQL injection</p>
<p><strong>When Called</strong></p>
<p>Internally by database functions when building SQL queries with dynamic identifiers</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>id</code> (<em>string</em>): Identifier to escape (table name, column name, etc.)</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Escaped identifier string wrapped in backticks</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c1">-- Simple: Escape a column name</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">escapedColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">escapeIdentifier</span><span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">)</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="c1">-- Returns: `user_name`</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c1">-- Medium: Escape multiple identifiers</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">buildSelectQuery</span><span class="p">(</span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columns</span><span class="p">)</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">escapedTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">escapeIdentifier</span><span class="p">(</span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">escapedColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">columns</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">escapedColumns</span><span class="p">,</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">escapeIdentifier</span><span class="p">(</span><span class="nv">column</span><span class="p">))</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;SELECT &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">escapedColumns</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; FROM &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">escapedTable</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1">-- High: Escape with validation and error handling</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">safeEscapeIdentifiers</span><span class="p">(</span><span class="nv">identifiers</span><span class="p">)</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">escaped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">identifiers</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="nv">id</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="nf">match</span><span class="p">(</span><span class="s2">&quot;^[a-zA-Z_][a-zA-Z0-9_]*$&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">escaped</span><span class="p">,</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">escapeIdentifier</span><span class="p">(</span><span class="nv">id</span><span class="p">))</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">            </span><span class="kr">else</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">                </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Invalid identifier: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">id</span><span class="p">))</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">                </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">escaped</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">    </span><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="upsert">upsert</h3>
<p><strong>Purpose</strong></p>
<p>Inserts a new record or updates an existing one based on primary key conflicts</p>
<p><strong>When Called</strong></p>
<p>When synchronizing data that may already exist, like configuration updates or data imports</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>value</code> (<em>table</em>): Key-value pairs representing the data to upsert</li>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'characters')</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results and lastID</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c1">-- Simple: Upsert configuration</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">upsert</span><span class="p">({</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;serverName&quot;</span><span class="p">,</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;My Server&quot;</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="p">},</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuration upserted&quot;</span><span class="p">)</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1">-- Medium: Upsert with validation and logging</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">syncPlayerData</span><span class="p">(</span><span class="nv">player</span><span class="p">)</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">playerData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="nv">steamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">SteamID</span><span class="p">(),</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">    </span><span class="nv">steamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">Name</span><span class="p">(),</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">    </span><span class="nv">lastJoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">    </span><span class="nv">userGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">GetUserGroup</span><span class="p">()</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">upsert</span><span class="p">(</span><span class="nv">playerData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;players&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Player data synchronized: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">player</span><span class="p">:</span><span class="nf">Name</span><span class="p">())</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnPlayerDataSynced&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">player</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to sync player data: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1">-- High: Upsert with conflict resolution and validation</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">upsertWithValidation</span><span class="p">(</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">validationRules</span><span class="p">)</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">validateData</span><span class="p">(</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">validationRules</span><span class="p">)</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">validation</span><span class="p">.</span><span class="py">valid</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">reject</span><span class="p">(</span><span class="s2">&quot;Validation failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">validation</span><span class="p">.</span><span class="py">error</span><span class="p">)</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">upsert</span><span class="p">(</span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lastID</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s2">&quot;inserted&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;updated&quot;</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Record &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">action</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; in &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">)</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="w">    </span><span class="c1">-- Update cache if applicable</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">dbTable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;characters&quot;</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="p">[</span><span class="nv">data</span><span class="p">.</span><span class="py">id</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">lastID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRecordUpserted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">dbTable</span><span class="p">,</span><span class="w"> </span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">action</span><span class="p">)</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">action</span><span class="p">,</span><span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lastID</span><span class="p">}</span>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Upsert failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">err</span><span class="p">}</span>
</span><span id="__span-65-19"><a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-65-20"><a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="delete">delete</h3>
<p><strong>Purpose</strong></p>
<p>Deletes records from a database table based on specified conditions</p>
<p><strong>When Called</strong></p>
<p>When removing data like deleted characters, expired items, or cleanup operations</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>dbTable</code> (<em>string, optional</em>): Table name without 'lia_' prefix (defaults to 'character')</li>
<li><code>condition</code> (<em>table/string, optional</em>): WHERE clause conditions for the deletion</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object with results and lastID</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1">-- Simple: Delete character by ID</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Character deleted&quot;</span><span class="p">)</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c1">-- Medium: Delete with validation and logging</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">deleteCharacter</span><span class="p">(</span><span class="nv">charID</span><span class="p">)</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">charID</span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">results</span><span class="p">,</span><span class="w"> </span><span class="nv">lastID</span><span class="p">)</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; deleted&quot;</span><span class="p">)</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterDeleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">charID</span><span class="p">)</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="c1">-- Clean up related data</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">invID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">charID</span><span class="p">})</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">&quot;inventories&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">charID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">charID</span><span class="p">})</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to delete character: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1">-- High: Delete with cascade and transaction safety</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">deleteCharacterWithCascade</span><span class="p">(</span><span class="nv">charID</span><span class="p">)</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">transaction</span><span class="p">({</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="w">    </span><span class="s2">&quot;DELETE FROM lia_items WHERE invID IN (SELECT invID FROM lia_inventories WHERE charID = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">,</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">    </span><span class="s2">&quot;DELETE FROM lia_inventories WHERE charID = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="p">,</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">    </span><span class="s2">&quot;DELETE FROM lia_chardata WHERE charID = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="p">,</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">    </span><span class="s2">&quot;DELETE FROM lia_characters WHERE id = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">    </span><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">charID</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; and all related data deleted&quot;</span><span class="p">)</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">    </span><span class="c1">-- Update cache</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">char</span><span class="p">.</span><span class="py">cache</span><span class="p">[</span><span class="nv">charID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterDeleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">charID</span><span class="p">)</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">charID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">charID</span><span class="p">}</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to delete character with cascade: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">err</span><span class="p">}</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="createtable">createTable</h3>
<p><strong>Purpose</strong></p>
<p>Creates a new database table with specified schema and primary key</p>
<p><strong>When Called</strong></p>
<p>When setting up custom tables for modules or extending the database schema</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>dbName</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>primaryKey</code> (<em>string, optional</em>): Primary key column name</li>
<li><code>schema</code> (<em>table</em>): Array of column definitions with name, type, not_null, and default properties</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to true on success</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1">-- Simple: Create a basic table</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createTable</span><span class="p">(</span><span class="s2">&quot;custom_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">not_null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;TEXT&quot;</span><span class="p">}</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="p">}):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table created successfully&quot;</span><span class="p">)</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1">-- Medium: Create table with validation</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">createPlayerStatsTable</span><span class="p">()</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">not_null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;steamID&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">not_null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kills&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;deaths&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lastUpdated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;CURRENT_TIMESTAMP&quot;</span><span class="p">}</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createTable</span><span class="p">(</span><span class="s2">&quot;player_stats&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">schema</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Player stats table created&quot;</span><span class="p">)</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnPlayerStatsTableCreated&quot;</span><span class="p">)</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to create player stats table: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c1">-- High: Create table with validation and error handling</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">createModuleTable</span><span class="p">(</span><span class="nv">moduleName</span><span class="p">,</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">)</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">validateSchema</span><span class="p">(</span><span class="nv">schema</span><span class="p">)</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">schema</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">type</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">                </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Invalid column definition&quot;</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="w">            </span><span class="kr">end</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">valid</span><span class="p">,</span><span class="w"> </span><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">validateSchema</span><span class="p">(</span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">schema</span><span class="p">)</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">valid</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">reject</span><span class="p">(</span><span class="s2">&quot;Schema validation failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">error</span><span class="p">)</span>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s2">&quot;lia_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">moduleName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">name</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Table already exists: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">moduleName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">name</span><span class="p">)</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createTable</span><span class="p">(</span><span class="nv">moduleName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">name</span><span class="p">,</span>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="w">    </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">primaryKey</span><span class="p">,</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">schema</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Module table created: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">moduleName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">name</span><span class="p">)</span>
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnModuleTableCreated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">moduleName</span><span class="p">,</span><span class="w"> </span><span class="nv">tableConfig</span><span class="p">.</span><span class="py">name</span><span class="p">)</span>
</span><span id="__span-71-25"><a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-71-26"><a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">success</span>
</span><span id="__span-71-27"><a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-71-28"><a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-71-29"><a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="createcolumn">createColumn</h3>
<p><strong>Purpose</strong></p>
<p>Adds a new column to an existing database table</p>
<p><strong>When Called</strong></p>
<p>When extending table schemas, adding new fields, or during database migrations</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>tableName</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>columnName</code> (<em>string</em>): Name of the new column to add</li>
<li><code>columnType</code> (<em>string</em>): SQL data type for the column</li>
<li><code>defaultValue</code> (<em>any, optional</em>): Default value for the column</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to true on success, false if column already exists</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1">-- Simple: Add a new column</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createColumn</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;level&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Level column added&quot;</span><span class="p">)</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column already exists&quot;</span><span class="p">)</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1">-- Medium: Add column with validation</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">addPlayerStatsColumn</span><span class="p">()</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createColumn</span><span class="p">(</span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;totalPlayTime&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Added totalPlayTime column to players table&quot;</span><span class="p">)</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnColumnAdded&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;totalPlayTime&quot;</span><span class="p">)</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="w">        </span><span class="kr">else</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;totalPlayTime column already exists&quot;</span><span class="p">)</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="w">    </span><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to add column: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1">-- High: Add column with validation and error handling</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">migrateCharacterTable</span><span class="p">()</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">newColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;level&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;experience&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">    </span><span class="p">{</span><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lastLevelUp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;CURRENT_TIMESTAMP&quot;</span><span class="p">}</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">addNextColumn</span><span class="p">(</span><span class="nv">index</span><span class="p">)</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">#</span><span class="nv">newColumns</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character table migration completed&quot;</span><span class="p">)</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">resolve</span><span class="p">()</span>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">newColumns</span><span class="p">[</span><span class="nv">index</span><span class="p">]</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createColumn</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">name</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">type</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">default</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Added column: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">name</span><span class="p">)</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nf">addNextColumn</span><span class="p">(</span><span class="nv">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="w">    </span><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to add column &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">column</span><span class="p">.</span><span class="py">name</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-74-21"><a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nf">addNextColumn</span><span class="p">(</span><span class="nv">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-74-22"><a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-74-23"><a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="kr">end</span>
</span><span id="__span-74-24"><a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a><span class="kr">return</span><span class="w"> </span><span class="nf">addNextColumn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-74-25"><a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="removetable">removeTable</h3>
<p><strong>Purpose</strong></p>
<p>Removes a database table and all its data from the database</p>
<p><strong>When Called</strong></p>
<p>When cleaning up unused tables, removing modules, or during database maintenance</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>tableName</code> (<em>string</em>): Table name without 'lia_' prefix</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to true on success, false if table doesn't exist</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1">-- Simple: Remove a table</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">removeTable</span><span class="p">(</span><span class="s2">&quot;old_data&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table removed&quot;</span><span class="p">)</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="c1">-- Medium: Remove table with validation</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">cleanupOldModule</span><span class="p">(</span><span class="nv">moduleName</span><span class="p">)</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">removeTable</span><span class="p">(</span><span class="nv">moduleName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;_data&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Removed table for module: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">moduleName</span><span class="p">)</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnModuleTableRemoved&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">moduleName</span><span class="p">)</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a><span class="w">        </span><span class="kr">else</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Table for module &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">moduleName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a><span class="w">    </span><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to remove table: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1">-- High: Remove table with backup and validation</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">removeTableWithBackup</span><span class="p">(</span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s2">&quot;lia_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Table &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="w">    </span><span class="c1">-- Create backup before removal</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createSnapshot</span><span class="p">(</span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Created backup: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="p">)</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">removeTable</span><span class="p">(</span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Table &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; removed successfully&quot;</span><span class="p">)</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTableRemoved&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">success</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-77-18"><a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-77-19"><a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to backup table &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-77-20"><a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-77-21"><a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-77-22"><a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-77-23"><a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="removecolumn">removeColumn</h3>
<p><strong>Purpose</strong></p>
<p>Removes a column from an existing database table using table recreation</p>
<p><strong>When Called</strong></p>
<p>When removing unused columns, cleaning up schemas, or during database migrations</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>tableName</code> (<em>string</em>): Table name without 'lia_' prefix</li>
<li><code>columnName</code> (<em>string</em>): Name of the column to remove</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to true on success, false if column doesn't exist</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1">-- Simple: Remove a column</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">removeColumn</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;old_field&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column removed&quot;</span><span class="p">)</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="c1">-- Medium: Remove column with validation</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">cleanupOldColumn</span><span class="p">(</span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">)</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">removeColumn</span><span class="p">(</span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Removed column &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">columnName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; from &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnColumnRemoved&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">)</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">        </span><span class="kr">else</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Column &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">columnName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; doesn&#39;t exist in &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="w">    </span><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to remove column: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1">-- High: Remove column with backup and validation</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">removeColumnWithBackup</span><span class="p">(</span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">)</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s2">&quot;lia_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">tableExists</span><span class="p">)</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">tableExists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Table &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">fieldExists</span><span class="p">(</span><span class="s2">&quot;lia_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">columnExists</span><span class="p">)</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">columnExists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Column &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">columnName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="w">    </span><span class="c1">-- Create backup before removal</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createSnapshot</span><span class="p">(</span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Created backup before column removal: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="p">)</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">removeColumn</span><span class="p">(</span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">success</span><span class="p">)</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">success</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Column &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">columnName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; removed from &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a><span class="w">        </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnColumnRemoved&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">columnName</span><span class="p">,</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">success</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to backup table before column removal: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-80-26"><a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-80-27"><a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-80-28"><a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-80-29"><a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="getcharactertable">getCharacterTable</h3>
<p><strong>Purpose</strong></p>
<p>Retrieves the column information for the lia_characters table</p>
<p><strong>When Called</strong></p>
<p>When analyzing character table structure, generating reports, or during schema validation</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>callback</code> (<em>function</em>): Function to call with the column information array</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>None</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1">-- Simple: Get character table columns</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">getCharacterTable</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">columns</span><span class="p">)</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Character table has &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="o">#</span><span class="nv">columns</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; columns&quot;</span><span class="p">)</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">columns</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">column</span><span class="p">)</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="kr">end</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1">-- Medium: Get columns with analysis</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">analyzeCharacterTable</span><span class="p">()</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">getCharacterTable</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">columns</span><span class="p">)</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">requiredColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;steamID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;faction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money&quot;</span><span class="p">}</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">missingColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">required</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">requiredColumns</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">HasValue</span><span class="p">(</span><span class="nv">columns</span><span class="p">,</span><span class="w"> </span><span class="nv">required</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">missingColumns</span><span class="p">,</span><span class="w"> </span><span class="nv">required</span><span class="p">)</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">missingColumns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Missing character columns: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">missingColumns</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="w">        </span><span class="kr">else</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;All required character columns present&quot;</span><span class="p">)</span>
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="w">    </span><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="c1">-- High: Get columns with validation and error handling</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">validateCharacterSchema</span><span class="p">()</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">waitForTablesToLoad</span><span class="p">():</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">getCharacterTable</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">columns</span><span class="p">)</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">columns</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">#</span><span class="nv">columns</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to get character table columns&quot;</span><span class="p">)</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="w">        </span><span class="kr">return</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">schemaValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="w">    </span><span class="nv">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;steamID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;faction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;money&quot;</span><span class="p">},</span>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="w">    </span><span class="nv">optional</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;attribs&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;schema&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;createTime&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lastJoinTime&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;recognition&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fakenames&quot;</span><span class="p">}</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">validationResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a><span class="w">    </span><span class="nv">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a><span class="w">    </span><span class="nv">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span>
</span><span id="__span-83-16"><a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a><span class="w">    </span><span class="nv">extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-83-17"><a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-83-18"><a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a><span class="w">    </span><span class="c1">-- Check for missing required columns</span>
</span><span id="__span-83-19"><a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">required</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">schemaValidation</span><span class="p">.</span><span class="py">required</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-83-20"><a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">HasValue</span><span class="p">(</span><span class="nv">columns</span><span class="p">,</span><span class="w"> </span><span class="nv">required</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-83-21"><a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a><span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">validationResults</span><span class="p">.</span><span class="py">missing</span><span class="p">,</span><span class="w"> </span><span class="nv">required</span><span class="p">)</span>
</span><span id="__span-83-22"><a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a><span class="w">            </span><span class="nv">validationResults</span><span class="p">.</span><span class="py">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-83-23"><a id="__codelineno-83-23" name="__codelineno-83-23" href="#__codelineno-83-23"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-83-24"><a id="__codelineno-83-24" name="__codelineno-83-24" href="#__codelineno-83-24"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-83-25"><a id="__codelineno-83-25" name="__codelineno-83-25" href="#__codelineno-83-25"></a><span class="w">    </span><span class="c1">-- Check for extra columns</span>
</span><span id="__span-83-26"><a id="__codelineno-83-26" name="__codelineno-83-26" href="#__codelineno-83-26"></a><span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">columns</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-83-27"><a id="__codelineno-83-27" name="__codelineno-83-27" href="#__codelineno-83-27"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">HasValue</span><span class="p">(</span><span class="nv">schemaValidation</span><span class="p">.</span><span class="py">required</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span>
</span><span id="__span-83-28"><a id="__codelineno-83-28" name="__codelineno-83-28" href="#__codelineno-83-28"></a><span class="w">        </span><span class="ow">not</span><span class="w"> </span><span class="nv">table</span><span class="p">.</span><span class="nf">HasValue</span><span class="p">(</span><span class="nv">schemaValidation</span><span class="p">.</span><span class="py">optional</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-83-29"><a id="__codelineno-83-29" name="__codelineno-83-29" href="#__codelineno-83-29"></a><span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">validationResults</span><span class="p">.</span><span class="py">extra</span><span class="p">,</span><span class="w"> </span><span class="nv">column</span><span class="p">)</span>
</span><span id="__span-83-30"><a id="__codelineno-83-30" name="__codelineno-83-30" href="#__codelineno-83-30"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-83-31"><a id="__codelineno-83-31" name="__codelineno-83-31" href="#__codelineno-83-31"></a><span class="kr">end</span>
</span><span id="__span-83-32"><a id="__codelineno-83-32" name="__codelineno-83-32" href="#__codelineno-83-32"></a><span class="kr">if</span><span class="w"> </span><span class="nv">validationResults</span><span class="p">.</span><span class="py">valid</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-83-33"><a id="__codelineno-83-33" name="__codelineno-83-33" href="#__codelineno-83-33"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character table schema validation passed&quot;</span><span class="p">)</span>
</span><span id="__span-83-34"><a id="__codelineno-83-34" name="__codelineno-83-34" href="#__codelineno-83-34"></a><span class="w">    </span><span class="kr">else</span>
</span><span id="__span-83-35"><a id="__codelineno-83-35" name="__codelineno-83-35" href="#__codelineno-83-35"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Character table schema issues found&quot;</span><span class="p">)</span>
</span><span id="__span-83-36"><a id="__codelineno-83-36" name="__codelineno-83-36" href="#__codelineno-83-36"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">validationResults</span><span class="p">.</span><span class="py">missing</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-83-37"><a id="__codelineno-83-37" name="__codelineno-83-37" href="#__codelineno-83-37"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Missing columns: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">validationResults</span><span class="p">.</span><span class="py">missing</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</span><span id="__span-83-38"><a id="__codelineno-83-38" name="__codelineno-83-38" href="#__codelineno-83-38"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-83-39"><a id="__codelineno-83-39" name="__codelineno-83-39" href="#__codelineno-83-39"></a><span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">validationResults</span><span class="p">.</span><span class="py">extra</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-83-40"><a id="__codelineno-83-40" name="__codelineno-83-40" href="#__codelineno-83-40"></a><span class="w">            </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Extra columns: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">table.concat</span><span class="p">(</span><span class="nv">validationResults</span><span class="p">.</span><span class="py">extra</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</span><span id="__span-83-41"><a id="__codelineno-83-41" name="__codelineno-83-41" href="#__codelineno-83-41"></a><span class="w">        </span><span class="kr">end</span>
</span><span id="__span-83-42"><a id="__codelineno-83-42" name="__codelineno-83-42" href="#__codelineno-83-42"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-83-43"><a id="__codelineno-83-43" name="__codelineno-83-43" href="#__codelineno-83-43"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnCharacterSchemaValidated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">validationResults</span><span class="p">)</span>
</span><span id="__span-83-44"><a id="__codelineno-83-44" name="__codelineno-83-44" href="#__codelineno-83-44"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-83-45"><a id="__codelineno-83-45" name="__codelineno-83-45" href="#__codelineno-83-45"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-83-46"><a id="__codelineno-83-46" name="__codelineno-83-46" href="#__codelineno-83-46"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Character schema validation failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-83-47"><a id="__codelineno-83-47" name="__codelineno-83-47" href="#__codelineno-83-47"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-83-48"><a id="__codelineno-83-48" name="__codelineno-83-48" href="#__codelineno-83-48"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="createsnapshot">createSnapshot</h3>
<p><strong>Purpose</strong></p>
<p>Creates a backup snapshot of a database table and saves it to a JSON file</p>
<p><strong>When Called</strong></p>
<p>When backing up data before major operations, creating restore points, or archiving data</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>tableName</code> (<em>string</em>): Table name without 'lia_' prefix</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to snapshot information (file, path, records)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1">-- Simple: Create a snapshot</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createSnapshot</span><span class="p">(</span><span class="s2">&quot;characters&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Snapshot created: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="p">)</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Records backed up: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">records</span><span class="p">)</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="c1">-- Medium: Create snapshot with validation</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">backupTable</span><span class="p">(</span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createSnapshot</span><span class="p">(</span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Backup created: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records)&quot;</span><span class="p">)</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTableBackedUp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">snapshot</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to backup table &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c1">-- High: Create snapshot with validation and error handling</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">createBackupWithValidation</span><span class="p">(</span><span class="nv">tableName</span><span class="p">)</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">tableExists</span><span class="p">(</span><span class="s2">&quot;lia_&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">exists</span><span class="p">)</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">exists</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">deferred</span><span class="p">.</span><span class="nf">new</span><span class="p">():</span><span class="nf">reject</span><span class="p">(</span><span class="s2">&quot;Table &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; doesn&#39;t exist&quot;</span><span class="p">)</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">createSnapshot</span><span class="p">(</span><span class="nv">tableName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">snapshot</span><span class="p">)</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="w">    </span><span class="c1">-- Validate snapshot data</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Snapshot created but table is empty&quot;</span><span class="p">)</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="w">    </span><span class="c1">-- Create backup metadata</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="w">    </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tableName</span><span class="p">,</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="w">    </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">timestamp</span><span class="p">,</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="w">    </span><span class="nv">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">records</span><span class="p">,</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a><span class="w">    </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="p">,</span>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a><span class="w">    </span><span class="nv">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">path</span><span class="p">,</span>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a><span class="w">    </span><span class="nv">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">GetHostName</span><span class="p">(),</span>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a><span class="w">    </span><span class="nv">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">version</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;unknown&quot;</span>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a><span class="w">    </span><span class="c1">-- Save metadata</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">metadataFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lilia/snapshots/&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;.meta&quot;</span>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a><span class="w">    </span><span class="nv">file</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">metadataFile</span><span class="p">,</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">TableToJSON</span><span class="p">(</span><span class="nv">metadata</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Backup completed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">file</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">snapshot</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records)&quot;</span><span class="p">)</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnBackupCreated&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">metadata</span><span class="p">)</span>
</span><span id="__span-86-27"><a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">metadata</span>
</span><span id="__span-86-28"><a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-86-29"><a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Backup failed for &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">tableName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-86-30"><a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a><span class="kr">return</span><span class="w"> </span><span class="p">{</span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">err</span><span class="p">}</span>
</span><span id="__span-86-31"><a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-86-32"><a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-86-33"><a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="loadsnapshot">loadSnapshot</h3>
<p><strong>Purpose</strong></p>
<p>Restores a database table from a previously created snapshot file</p>
<p><strong>When Called</strong></p>
<p>When restoring data from backups, recovering from errors, or migrating data</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fileName</code> (<em>string</em>): Name of the snapshot file to load</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to restore information (table, records, timestamp)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="c1">-- Simple: Load a snapshot</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="s2">&quot;snapshot_characters_1234567890.json&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1">-- Medium: Load snapshot with validation</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreTable</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTableRestored&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">)</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">result</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to restore from &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="c1">-- High: Load snapshot with validation and error handling</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreWithValidation</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="w">    </span><span class="c1">-- Validate restore results</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed but no records were loaded&quot;</span><span class="p">)</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="w">    </span><span class="c1">-- Verify table exists and has data</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Record count mismatch: expected &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;, got &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="w">    </span><span class="c1">-- Create restore log entry</span>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">restoreLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a><span class="w">    </span><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a><span class="w">    </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span>
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a><span class="w">    </span><span class="nv">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">,</span>
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a><span class="w">    </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">timestamp</span><span class="p">,</span>
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a><span class="w">    </span><span class="nv">restoredAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a><span class="w">    </span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-89-21"><a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-89-22"><a id="__codelineno-89-22" name="__codelineno-89-22" href="#__codelineno-89-22"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed successfully: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-89-23"><a id="__codelineno-89-23" name="__codelineno-89-23" href="#__codelineno-89-23"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreCompleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">restoreLog</span><span class="p">)</span>
</span><span id="__span-89-24"><a id="__codelineno-89-24" name="__codelineno-89-24" href="#__codelineno-89-24"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">restoreLog</span>
</span><span id="__span-89-25"><a id="__codelineno-89-25" name="__codelineno-89-25" href="#__codelineno-89-25"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-89-26"><a id="__codelineno-89-26" name="__codelineno-89-26" href="#__codelineno-89-26"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-89-27"><a id="__codelineno-89-27" name="__codelineno-89-27" href="#__codelineno-89-27"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Restore failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-89-28"><a id="__codelineno-89-28" name="__codelineno-89-28" href="#__codelineno-89-28"></a><span class="c1">-- Log failed restore attempt</span>
</span><span id="__span-89-29"><a id="__codelineno-89-29" name="__codelineno-89-29" href="#__codelineno-89-29"></a><span class="kd">local</span><span class="w"> </span><span class="nv">failedLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-30"><a id="__codelineno-89-30" name="__codelineno-89-30" href="#__codelineno-89-30"></a><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-89-31"><a id="__codelineno-89-31" name="__codelineno-89-31" href="#__codelineno-89-31"></a><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">),</span>
</span><span id="__span-89-32"><a id="__codelineno-89-32" name="__codelineno-89-32" href="#__codelineno-89-32"></a><span class="nv">failedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-89-33"><a id="__codelineno-89-33" name="__codelineno-89-33" href="#__codelineno-89-33"></a><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-89-34"><a id="__codelineno-89-34" name="__codelineno-89-34" href="#__codelineno-89-34"></a><span class="p">}</span>
</span><span id="__span-89-35"><a id="__codelineno-89-35" name="__codelineno-89-35" href="#__codelineno-89-35"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreFailed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">failedLog</span><span class="p">)</span>
</span><span id="__span-89-36"><a id="__codelineno-89-36" name="__codelineno-89-36" href="#__codelineno-89-36"></a><span class="kr">return</span><span class="w"> </span><span class="nv">failedLog</span>
</span><span id="__span-89-37"><a id="__codelineno-89-37" name="__codelineno-89-37" href="#__codelineno-89-37"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-89-38"><a id="__codelineno-89-38" name="__codelineno-89-38" href="#__codelineno-89-38"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="liagmregisterpreparedstatements">lia.GM:RegisterPreparedStatements</h3>
<p><strong>Purpose</strong></p>
<p>Restores a database table from a previously created snapshot file</p>
<p><strong>When Called</strong></p>
<p>When restoring data from backups, recovering from errors, or migrating data</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fileName</code> (<em>string</em>): Name of the snapshot file to load</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to restore information (table, records, timestamp)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="c1">-- Simple: Load a snapshot</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="s2">&quot;snapshot_characters_1234567890.json&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="c1">-- Medium: Load snapshot with validation</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreTable</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTableRestored&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">)</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">result</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to restore from &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="c1">-- High: Load snapshot with validation and error handling</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreWithValidation</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="w">    </span><span class="c1">-- Validate restore results</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed but no records were loaded&quot;</span><span class="p">)</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="w">    </span><span class="c1">-- Verify table exists and has data</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Record count mismatch: expected &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;, got &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-92-13"><a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a><span class="w">    </span><span class="c1">-- Create restore log entry</span>
</span><span id="__span-92-14"><a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">restoreLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-92-15"><a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a><span class="w">    </span><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-92-16"><a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a><span class="w">    </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span>
</span><span id="__span-92-17"><a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a><span class="w">    </span><span class="nv">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">,</span>
</span><span id="__span-92-18"><a id="__codelineno-92-18" name="__codelineno-92-18" href="#__codelineno-92-18"></a><span class="w">    </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">timestamp</span><span class="p">,</span>
</span><span id="__span-92-19"><a id="__codelineno-92-19" name="__codelineno-92-19" href="#__codelineno-92-19"></a><span class="w">    </span><span class="nv">restoredAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-92-20"><a id="__codelineno-92-20" name="__codelineno-92-20" href="#__codelineno-92-20"></a><span class="w">    </span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-92-21"><a id="__codelineno-92-21" name="__codelineno-92-21" href="#__codelineno-92-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-92-22"><a id="__codelineno-92-22" name="__codelineno-92-22" href="#__codelineno-92-22"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed successfully: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-92-23"><a id="__codelineno-92-23" name="__codelineno-92-23" href="#__codelineno-92-23"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreCompleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">restoreLog</span><span class="p">)</span>
</span><span id="__span-92-24"><a id="__codelineno-92-24" name="__codelineno-92-24" href="#__codelineno-92-24"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">restoreLog</span>
</span><span id="__span-92-25"><a id="__codelineno-92-25" name="__codelineno-92-25" href="#__codelineno-92-25"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-92-26"><a id="__codelineno-92-26" name="__codelineno-92-26" href="#__codelineno-92-26"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-92-27"><a id="__codelineno-92-27" name="__codelineno-92-27" href="#__codelineno-92-27"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Restore failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-92-28"><a id="__codelineno-92-28" name="__codelineno-92-28" href="#__codelineno-92-28"></a><span class="c1">-- Log failed restore attempt</span>
</span><span id="__span-92-29"><a id="__codelineno-92-29" name="__codelineno-92-29" href="#__codelineno-92-29"></a><span class="kd">local</span><span class="w"> </span><span class="nv">failedLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-92-30"><a id="__codelineno-92-30" name="__codelineno-92-30" href="#__codelineno-92-30"></a><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-92-31"><a id="__codelineno-92-31" name="__codelineno-92-31" href="#__codelineno-92-31"></a><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">),</span>
</span><span id="__span-92-32"><a id="__codelineno-92-32" name="__codelineno-92-32" href="#__codelineno-92-32"></a><span class="nv">failedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-92-33"><a id="__codelineno-92-33" name="__codelineno-92-33" href="#__codelineno-92-33"></a><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-92-34"><a id="__codelineno-92-34" name="__codelineno-92-34" href="#__codelineno-92-34"></a><span class="p">}</span>
</span><span id="__span-92-35"><a id="__codelineno-92-35" name="__codelineno-92-35" href="#__codelineno-92-35"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreFailed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">failedLog</span><span class="p">)</span>
</span><span id="__span-92-36"><a id="__codelineno-92-36" name="__codelineno-92-36" href="#__codelineno-92-36"></a><span class="kr">return</span><span class="w"> </span><span class="nv">failedLog</span>
</span><span id="__span-92-37"><a id="__codelineno-92-37" name="__codelineno-92-37" href="#__codelineno-92-37"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-92-38"><a id="__codelineno-92-38" name="__codelineno-92-38" href="#__codelineno-92-38"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="liagmsetupdatabase">lia.GM:SetupDatabase</h3>
<p><strong>Purpose</strong></p>
<p>Restores a database table from a previously created snapshot file</p>
<p><strong>When Called</strong></p>
<p>When restoring data from backups, recovering from errors, or migrating data</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fileName</code> (<em>string</em>): Name of the snapshot file to load</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to restore information (table, records, timestamp)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="c1">-- Simple: Load a snapshot</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="s2">&quot;snapshot_characters_1234567890.json&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="c1">-- Medium: Load snapshot with validation</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreTable</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTableRestored&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">)</span>
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">result</span>
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to restore from &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-94-9"><a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-94-10"><a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="c1">-- High: Load snapshot with validation and error handling</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreWithValidation</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a><span class="w">    </span><span class="c1">-- Validate restore results</span>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed but no records were loaded&quot;</span><span class="p">)</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a><span class="w">    </span><span class="c1">-- Verify table exists and has data</span>
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Record count mismatch: expected &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;, got &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-95-13"><a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a><span class="w">    </span><span class="c1">-- Create restore log entry</span>
</span><span id="__span-95-14"><a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">restoreLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-15"><a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a><span class="w">    </span><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-95-16"><a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a><span class="w">    </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span>
</span><span id="__span-95-17"><a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a><span class="w">    </span><span class="nv">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">,</span>
</span><span id="__span-95-18"><a id="__codelineno-95-18" name="__codelineno-95-18" href="#__codelineno-95-18"></a><span class="w">    </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">timestamp</span><span class="p">,</span>
</span><span id="__span-95-19"><a id="__codelineno-95-19" name="__codelineno-95-19" href="#__codelineno-95-19"></a><span class="w">    </span><span class="nv">restoredAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-95-20"><a id="__codelineno-95-20" name="__codelineno-95-20" href="#__codelineno-95-20"></a><span class="w">    </span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-95-21"><a id="__codelineno-95-21" name="__codelineno-95-21" href="#__codelineno-95-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-95-22"><a id="__codelineno-95-22" name="__codelineno-95-22" href="#__codelineno-95-22"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed successfully: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-95-23"><a id="__codelineno-95-23" name="__codelineno-95-23" href="#__codelineno-95-23"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreCompleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">restoreLog</span><span class="p">)</span>
</span><span id="__span-95-24"><a id="__codelineno-95-24" name="__codelineno-95-24" href="#__codelineno-95-24"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">restoreLog</span>
</span><span id="__span-95-25"><a id="__codelineno-95-25" name="__codelineno-95-25" href="#__codelineno-95-25"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-95-26"><a id="__codelineno-95-26" name="__codelineno-95-26" href="#__codelineno-95-26"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-95-27"><a id="__codelineno-95-27" name="__codelineno-95-27" href="#__codelineno-95-27"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Restore failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-95-28"><a id="__codelineno-95-28" name="__codelineno-95-28" href="#__codelineno-95-28"></a><span class="c1">-- Log failed restore attempt</span>
</span><span id="__span-95-29"><a id="__codelineno-95-29" name="__codelineno-95-29" href="#__codelineno-95-29"></a><span class="kd">local</span><span class="w"> </span><span class="nv">failedLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-30"><a id="__codelineno-95-30" name="__codelineno-95-30" href="#__codelineno-95-30"></a><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-95-31"><a id="__codelineno-95-31" name="__codelineno-95-31" href="#__codelineno-95-31"></a><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">),</span>
</span><span id="__span-95-32"><a id="__codelineno-95-32" name="__codelineno-95-32" href="#__codelineno-95-32"></a><span class="nv">failedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-95-33"><a id="__codelineno-95-33" name="__codelineno-95-33" href="#__codelineno-95-33"></a><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-95-34"><a id="__codelineno-95-34" name="__codelineno-95-34" href="#__codelineno-95-34"></a><span class="p">}</span>
</span><span id="__span-95-35"><a id="__codelineno-95-35" name="__codelineno-95-35" href="#__codelineno-95-35"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreFailed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">failedLog</span><span class="p">)</span>
</span><span id="__span-95-36"><a id="__codelineno-95-36" name="__codelineno-95-36" href="#__codelineno-95-36"></a><span class="kr">return</span><span class="w"> </span><span class="nv">failedLog</span>
</span><span id="__span-95-37"><a id="__codelineno-95-37" name="__codelineno-95-37" href="#__codelineno-95-37"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-95-38"><a id="__codelineno-95-38" name="__codelineno-95-38" href="#__codelineno-95-38"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />
<h3 id="liagmdatabaseconnected">lia.GM:DatabaseConnected</h3>
<p><strong>Purpose</strong></p>
<p>Restores a database table from a previously created snapshot file</p>
<p><strong>When Called</strong></p>
<p>When restoring data from backups, recovering from errors, or migrating data</p>
<p><strong>Parameters</strong></p>
<ul>
<li><code>fileName</code> (<em>string</em>): Name of the snapshot file to load</li>
</ul>
<p><strong>Returns</strong></p>
<ul>
<li>Deferred promise object resolving to restore information (table, records, timestamp)</li>
</ul>
<p><strong>Realm</strong></p>
<p>Server</p>
<p><strong>Example Usage</strong></p>
<p><strong>Low Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="c1">-- Simple: Load a snapshot</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="s2">&quot;snapshot_characters_1234567890.json&quot;</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-96-4"><a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="kr">end</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Medium Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1">-- Medium: Load snapshot with validation</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreTable</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restored &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; records to &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">)</span>
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnTableRestored&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">)</span>
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">result</span>
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-97-8"><a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Failed to restore from &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-97-9"><a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-97-10"><a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a><span class="kr">end</span>
</span></code></pre></div></p>
<p><strong>High Complexity:</strong>
<div class="language-lua highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="c1">-- High: Load snapshot with validation and error handling</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">restoreWithValidation</span><span class="p">(</span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="nv">fileName</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">result</span><span class="p">)</span>
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="w">    </span><span class="c1">-- Validate restore results</span>
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed but no records were loaded&quot;</span><span class="p">)</span>
</span><span id="__span-98-7"><a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-98-8"><a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a><span class="w">    </span><span class="c1">-- Verify table exists and has data</span>
</span><span id="__span-98-9"><a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">lia</span><span class="p">.</span><span class="py">db</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">):</span><span class="nb">next</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-98-10"><a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-98-11"><a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a><span class="w">        </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Record count mismatch: expected &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;, got &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">count</span><span class="p">)</span>
</span><span id="__span-98-12"><a id="__codelineno-98-12" name="__codelineno-98-12" href="#__codelineno-98-12"></a><span class="w">    </span><span class="kr">end</span>
</span><span id="__span-98-13"><a id="__codelineno-98-13" name="__codelineno-98-13" href="#__codelineno-98-13"></a><span class="w">    </span><span class="c1">-- Create restore log entry</span>
</span><span id="__span-98-14"><a id="__codelineno-98-14" name="__codelineno-98-14" href="#__codelineno-98-14"></a><span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">restoreLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-98-15"><a id="__codelineno-98-15" name="__codelineno-98-15" href="#__codelineno-98-15"></a><span class="w">    </span><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-98-16"><a id="__codelineno-98-16" name="__codelineno-98-16" href="#__codelineno-98-16"></a><span class="w">    </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">table</span><span class="p">,</span>
</span><span id="__span-98-17"><a id="__codelineno-98-17" name="__codelineno-98-17" href="#__codelineno-98-17"></a><span class="w">    </span><span class="nv">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">records</span><span class="p">,</span>
</span><span id="__span-98-18"><a id="__codelineno-98-18" name="__codelineno-98-18" href="#__codelineno-98-18"></a><span class="w">    </span><span class="nv">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">result</span><span class="p">.</span><span class="py">timestamp</span><span class="p">,</span>
</span><span id="__span-98-19"><a id="__codelineno-98-19" name="__codelineno-98-19" href="#__codelineno-98-19"></a><span class="w">    </span><span class="nv">restoredAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-98-20"><a id="__codelineno-98-20" name="__codelineno-98-20" href="#__codelineno-98-20"></a><span class="w">    </span><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-98-21"><a id="__codelineno-98-21" name="__codelineno-98-21" href="#__codelineno-98-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-98-22"><a id="__codelineno-98-22" name="__codelineno-98-22" href="#__codelineno-98-22"></a><span class="w">    </span><span class="nv">lia</span><span class="p">.</span><span class="py">log</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">&quot;Restore completed successfully: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">fileName</span><span class="p">)</span>
</span><span id="__span-98-23"><a id="__codelineno-98-23" name="__codelineno-98-23" href="#__codelineno-98-23"></a><span class="w">    </span><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreCompleted&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">restoreLog</span><span class="p">)</span>
</span><span id="__span-98-24"><a id="__codelineno-98-24" name="__codelineno-98-24" href="#__codelineno-98-24"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">restoreLog</span>
</span><span id="__span-98-25"><a id="__codelineno-98-25" name="__codelineno-98-25" href="#__codelineno-98-25"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-98-26"><a id="__codelineno-98-26" name="__codelineno-98-26" href="#__codelineno-98-26"></a><span class="kr">end</span><span class="p">):</span><span class="nf">catch</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="nv">err</span><span class="p">)</span>
</span><span id="__span-98-27"><a id="__codelineno-98-27" name="__codelineno-98-27" href="#__codelineno-98-27"></a><span class="nv">lia</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">&quot;Restore failed: &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">))</span>
</span><span id="__span-98-28"><a id="__codelineno-98-28" name="__codelineno-98-28" href="#__codelineno-98-28"></a><span class="c1">-- Log failed restore attempt</span>
</span><span id="__span-98-29"><a id="__codelineno-98-29" name="__codelineno-98-29" href="#__codelineno-98-29"></a><span class="kd">local</span><span class="w"> </span><span class="nv">failedLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-98-30"><a id="__codelineno-98-30" name="__codelineno-98-30" href="#__codelineno-98-30"></a><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fileName</span><span class="p">,</span>
</span><span id="__span-98-31"><a id="__codelineno-98-31" name="__codelineno-98-31" href="#__codelineno-98-31"></a><span class="nb">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">err</span><span class="p">),</span>
</span><span id="__span-98-32"><a id="__codelineno-98-32" name="__codelineno-98-32" href="#__codelineno-98-32"></a><span class="nv">failedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">os.time</span><span class="p">(),</span>
</span><span id="__span-98-33"><a id="__codelineno-98-33" name="__codelineno-98-33" href="#__codelineno-98-33"></a><span class="nv">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-98-34"><a id="__codelineno-98-34" name="__codelineno-98-34" href="#__codelineno-98-34"></a><span class="p">}</span>
</span><span id="__span-98-35"><a id="__codelineno-98-35" name="__codelineno-98-35" href="#__codelineno-98-35"></a><span class="nv">hook</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s2">&quot;OnRestoreFailed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">failedLog</span><span class="p">)</span>
</span><span id="__span-98-36"><a id="__codelineno-98-36" name="__codelineno-98-36" href="#__codelineno-98-36"></a><span class="kr">return</span><span class="w"> </span><span class="nv">failedLog</span>
</span><span id="__span-98-37"><a id="__codelineno-98-37" name="__codelineno-98-37" href="#__codelineno-98-37"></a><span class="kr">end</span><span class="p">)</span>
</span><span id="__span-98-38"><a id="__codelineno-98-38" name="__codelineno-98-38" href="#__codelineno-98-38"></a><span class="kr">end</span>
</span></code></pre></div></p>
<hr />












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lia.data/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Data Library">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Data Library
              </div>
            </div>
          </a>
        
        
          
          <a href="../lia.derma/" class="md-footer__link md-footer__link--next" aria-label="Next: Derma Library">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Derma Library
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.instant.preview", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "toc.follow", "toc.integrate", "navigation.top", "header.autohide", "announce.dismiss", "navigation.footer", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "content.tooltips", "content.footnote.tooltips"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>